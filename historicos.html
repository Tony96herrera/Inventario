<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥ricos de Inventario - Omnilife</title>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #e0e7ff 0%, #f8fafc 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto 0 auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(60,72,100,0.10);
            overflow: hidden;
            padding: 32px 24px 24px 24px;
        }
        h1 {
            color: #6366f1;
            font-size: 2rem;
            margin-bottom: 18px;
            text-align: center;
        }
        .volver {
            display: inline-block;
            margin-bottom: 18px;
            color: #6366f1;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: color 0.2s;
        }
        .volver:hover { color: #374151; }
        .date-select {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
        }
        .date-select label {
            font-weight: 600;
            color: #6366f1;
            font-size: 1.05rem;
        }
        .date-select input[type="date"] {
            padding: 8px 14px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            background: #f9fafb;
            transition: all 0.2s;
            height: 40px;
            min-width: 180px;
            box-sizing: border-box;
        }
        .date-select button {
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            height: 40px;
            min-width: 120px;
            transition: all 0.2s;
        }
        .date-select button:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        .info {
            margin-bottom: 18px;
            color: #374151;
            font-size: 1.08rem;
        }
        .table-container {
            max-height: 540px;
            overflow-y: auto;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(60,72,100,0.06);
            background: #fff;
            margin-bottom: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        th {
            background: #6366f1;
            color: #fff;
            padding: 11px 8px;
            text-align: left;
            font-weight: 700;
            font-size: 0.93rem;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 9px 7px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
            font-size: 0.98rem;
        }
        tr:nth-child(even) {background: #f9fafb;}
        .code-cell {font-family:'JetBrains Mono','Courier New',monospace;font-weight:600;color:#6366f1;font-size:0.93rem;}
        .product-cell {font-weight:500;color:#22223b;max-width:300px;word-wrap:break-word;}
        .no-data {
            color: #ef4444;
            text-align: center;
            font-size: 1.1rem;
            margin-top: 32px;
        }
        .btn-exportar-excel {
            background: linear-gradient(90deg, #60a5fa 0%, #6366f1 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(60,72,100,0.08);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.18s, transform 0.18s;
            margin-left: 10px;
            height: 40px;
            min-width: 180px;
            box-sizing: border-box;
        }
        .btn-exportar-excel:hover, .btn-exportar-excel:focus {
            background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
            color: #fff;
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px rgba(60,72,100,0.13);
        }
        .loading {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(60,72,100,0.18);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .loading.show {display:flex;}
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .footer {
            background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
            color: #fff;
            padding: 18px 32px;
            text-align: center;
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
            font-size: 1rem;
            letter-spacing: 0.2px;
            margin-top: 0;
        }
        .burguer-top {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .menu-hamburguesa {
            position: static;
            width: 38px;
            height: 38px;
            min-width: 38px;
            min-height: 38px;
            background: rgba(99,102,241,0.13);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 110;
            border: none;
            transition: background 0.2s;
        }
        .menu-hamburguesa:active {
            background: rgba(99,102,241,0.22);
        }
        .menu-hamburguesa span, .menu-hamburguesa span:before, .menu-hamburguesa span:after {
            display: block;
            background: #6366f1;
            height: 3px;
            width: 22px;
            border-radius: 2px;
            position: absolute;
            transition: all 0.3s;
        }
        .menu-hamburguesa span {
            position: relative;
        }
        .menu-hamburguesa span:before {
            content: '';
            top: -7px;
            position: absolute;
        }
        .menu-hamburguesa span:after {
            content: '';
            top: 7px;
            position: absolute;
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: -180px;
            width: 160px;
            height: 100%;
            background: linear-gradient(135deg,#6366f1 0%,#60a5fa 100%);
            color: #fff;
            box-shadow: 2px 0 16px rgba(60,72,100,0.10);
            z-index: 2000;
            transition: left 0.3s;
            padding-top: 50px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }
        .side-menu.open {
            left: 0;
        }
        .side-menu ul {
            list-style: none;
            padding: 0 0 0 16px;
        }
        .side-menu li {
            margin-bottom: 18px;
        }
        .side-menu a {
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.2s;
        }
        .side-menu a:hover {
            color: #fbbf24;
        }
        .side-menu .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .side-menu .menu-title {
            font-size: 1.05rem;
            font-weight: bold;
            margin-bottom: 18px;
            margin-left: 4px;
        }
        .tipo-historico-btns {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin-bottom: 28px;
        }
        .tipo-historico-btn {
            padding: 10px 22px;
            border-radius: 8px;
            border: none;
            font-size: 1.08rem;
            font-weight: 700;
            cursor: pointer;
            background: #e0e7ff;
            color: #6366f1;
            transition: background 0.18s, color 0.18s, transform 0.18s;
            box-shadow: 0 2px 8px rgba(60,72,100,0.06);
        }
        .tipo-historico-btn.selected,
        .tipo-historico-btn:hover {
            background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
            color: #fff;
            transform: translateY(-2px) scale(1.04);
        }
        .switch {
  position: relative;
  display: inline-block;
  width: 56px;
  height: 28px;
}
.switch input {display:none;}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #e0e7ff;
  transition: .4s;
  border-radius: 34px;
  box-shadow: 0 2px 8px rgba(60,72,100,0.06);
}
.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background: #e0e7ff;
}
input:checked + .slider:before {
  transform: translateX(28px);
}
        @media (max-width:700px) {
            .container {padding: 12px;}
            h1 {font-size: 1.2rem;}
            .table-container {margin-bottom: 10px;}
            th, td {font-size: 0.85rem;}
            .side-menu {
                width: 65vw;
                min-width: 120px;
                max-width: 220px;
                left: -65vw;
                border-radius: 0 0 14px 0;
                padding-top: 40px;
            }
            .side-menu.open {
                left: 0;
            }
            .side-menu .close-btn {
                top: 8px;
                right: 8px;
                font-size: 1.5rem;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    <!-- Men√∫ lateral -->
    <nav class="side-menu" id="sideMenu">
        <button class="close-btn" onclick="cerrarMenuLateral()" title="Cerrar men√∫">&times;</button>
        <div class="menu-title">Men√∫</div>
        <ul>
            <li><a href="Inventario Diario.html" onclick="cerrarMenuLateral()">Inventario Diario</a></li>
            <!-- <li><a href="historicos.html" onclick="cerrarMenuLateral()">Hist√≥ricos</a></li> -->
            <li><a href="Inventario%20General.html" onclick="cerrarMenuLateral()">Inventario General</a></li>
        </ul>
    </nav>
    <div class="container">
        <div class="burguer-top">
            <button class="menu-hamburguesa" onclick="abrirMenuLateral()" title="Men√∫" aria-label="Abrir men√∫">
                <span></span>
            </button>
        </div>
        <h1>Hist√≥ricos de Inventario</h1>
        <div style="display:flex;justify-content:center;align-items:center;margin-bottom:28px;">
    <span id="labelDiario" style="font-weight:700;color:#6366f1;font-size:1.08rem;margin-right:10px;">Inventario Diario</span>
    <label class="switch">
        <input type="checkbox" id="toggleTipoHistorico">
        <span class="slider"></span>
    </label>
    <span id="labelGeneral" style="font-weight:700;color:#6366f1;font-size:1.08rem;margin-left:10px;">Inventario General</span>
</div>
        <!-- Inventario por Fecha -->
        <div id="busquedaFecha" style="display:block;">
            <div class="date-select">
                <label for="fechaHist">Selecciona una fecha:</label>
                <input type="date" id="fechaHist">
                <button id="btnBuscarFecha">Buscar Registro</button>
                <button id="btnExportarExcelFecha" class="btn-exportar-excel" style="display:none;">
                    <span style="font-size:1.2em;vertical-align:middle;">üì•</span>
                    <span style="vertical-align:middle;">Exportar Excel</span>
                </button>
            </div>
            <div id="infoHistFecha" class="info"></div>
            <div class="table-container" id="tablaHistContainerFecha" style="display:none;">
                <table id="tablaHistFecha">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Texto breve de material</th>
                            <th>SAP</th>
                            <th>F√≠sico</th>
                            <th>Display</th>
                            <th>Merma</th>
                            <th>Diferencias</th>
                        </tr>
                    </thead>
                    <tbody id="tablaHistBodyFecha"></tbody>
                </table>
                <div class="footer">
                    <p style="margin:0;">&copy; 2025 Sistema de Inventario F√≠sico - Omnilife. Todos los derechos reservados.</p>
                </div>
            </div>
            <div class="no-data" id="noHistFecha" style="display:none;">No hay hist√≥rico para la fecha seleccionada.</div>
        </div>
        <!-- Inventario General -->
        <div id="busquedaGeneral" style="display:none;">
            <div class="date-select">
                <label for="fechaGeneral">Selecciona una fecha:</label>
                <input type="date" id="fechaGeneral">
                <button id="btnBuscarGeneral">Buscar Registro</button>
                <button id="btnExportarExcelGeneral" class="btn-exportar-excel" style="display:none;">
                    <span style="font-size:1.2em;vertical-align:middle;">üì•</span>
                    <span style="vertical-align:middle;">Exportar Excel</span>
                </button>
            </div>
            <div id="infoHistGeneral" class="info"></div>
            <div class="table-container" id="tablaHistContainerGeneral" style="display:none;">
                <table id="tablaHistGeneral">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Texto breve de material</th>
                            <th>SAP</th>
                            <th>F√≠sico</th>
                            <th>Display</th>
                            <th>Merma</th>
                            <th>Diferencias</th>
                        </tr>
                    </thead>
                    <tbody id="tablaHistBodyGeneral"></tbody>
                </table>
                <div class="footer">
                    <p style="margin:0;">&copy; 2025 Sistema de Inventario F√≠sico - Omnilife. Todos los derechos reservados.</p>
                </div>
            </div>
            <div class="no-data" id="noHistGeneral" style="display:none;">No hay hist√≥rico general para la fecha seleccionada.</div>
        </div>
    </div>

    <script>
        // Men√∫ lateral (id√©ntico a index.html)
        function abrirMenuLateral() {
            document.getElementById('sideMenu').classList.add('open');
        }
        function cerrarMenuLateral() {
            document.getElementById('sideMenu').classList.remove('open');
        }
        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('sideMenu');
            const burger = document.querySelector('.menu-hamburguesa');
            if (menu.classList.contains('open') && !menu.contains(e.target) && !burger.contains(e.target)) {
                cerrarMenuLateral();
            }
        });

        // Inicializa Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC0i3Btw_EhcRB-gwocAA3mHKQc2foE86w",
            authDomain: "inventario-cedis-64eef.firebaseapp.com",
            projectId: "inventario-cedis-64eef",
            storageBucket: "inventario-cedis-64eef.appspot.com",
            messagingSenderId: "730229452536",
            appId: "1:730229452536:web:cb011c50d795253037150d",
            measurementId: "G-G3X02X14X9"
        };
        
        // Solo inicializa Firebase una vez
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado en historicos.html");
        }
        const db = firebase.firestore();

        // Referencias a elementos DOM
        const busquedaFecha = document.getElementById('busquedaFecha');
        const busquedaGeneral = document.getElementById('busquedaGeneral');
        const toggleTipoHistorico = document.getElementById('toggleTipoHistorico');

        // Fecha
        const fechaInputFecha = document.getElementById('fechaHist');
        const btnBuscarFecha = document.getElementById('btnBuscarFecha');
        const btnExportarFecha = document.getElementById('btnExportarExcelFecha');
        const infoDivFecha = document.getElementById('infoHistFecha');
        const tablaContainerFecha = document.getElementById('tablaHistContainerFecha');
        const tablaBodyFecha = document.getElementById('tablaHistBodyFecha');
        const noHistFecha = document.getElementById('noHistFecha');

        // General
        const fechaInputGeneral = document.getElementById('fechaGeneral');
        const btnBuscarGeneral = document.getElementById('btnBuscarGeneral');
        const btnExportarGeneral = document.getElementById('btnExportarExcelGeneral');
        const infoDivGeneral = document.getElementById('infoHistGeneral');
        const tablaContainerGeneral = document.getElementById('tablaHistContainerGeneral');
        const tablaBodyGeneral = document.getElementById('tablaHistBodyGeneral');
        const noHistGeneral = document.getElementById('noHistGeneral');

        const loading = document.getElementById('loading');

        // Variables globales para ambos hist√≥ricos
        let historicoActualFecha = null;
        let historicoActualGeneral = null;

        // Normaliza la fecha a yyyy-mm-dd
        function normalizarFecha(fecha) {
            if (!fecha) return "";
            if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
                const [dd, mm, yyyy] = fecha.split('/');
                return `${yyyy}-${mm}-${dd}`;
            }
            if (/^\d{4}\/\d{2}\/\d{2}$/.test(fecha)) {
                return fecha.replace(/\//g, '-');
            }
            return fecha;
        }

        function showLoading(show) {
            loading.classList.toggle("show", !!show);
        }

        // Toggle switch para cambiar tipo de hist√≥rico
        toggleTipoHistorico.addEventListener('change', () => {
        if (toggleTipoHistorico.checked) {
            busquedaFecha.style.display = 'none';
            busquedaGeneral.style.display = 'block';
        } else {
            busquedaFecha.style.display = 'block';
            busquedaGeneral.style.display = 'none';
        }
    });

        // Inicializa con Inventario Diario visible
        busquedaFecha.style.display = 'block';
        busquedaGeneral.style.display = 'none';

        // Buscar hist√≥rico por fecha (inventario diario)
        async function buscarHistoricoFecha() {
            const fecha = fechaInputFecha.value;
            if (!fecha) {
                alert("Por favor selecciona una fecha para buscar.");
                return;
            }
            showLoading(true);
            tablaBodyFecha.innerHTML = '';
            infoDivFecha.innerHTML = '';
            tablaContainerFecha.style.display = 'none';
            noHistFecha.style.display = 'none';
            btnExportarFecha.style.display = 'none';
            historicoActualFecha = null;

            try {
                // Asegura que la fecha est√© en formato yyyy-mm-dd (con ceros)
                let fechaKey = normalizarFecha(fecha);
                // Si el input es tipo date, ya viene en yyyy-mm-dd
                // Firestore distingue "2025-08-06" de "2025-8-6", as√≠ que fuerza el formato con ceros
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaKey)) {
                    const [yyyy, mm, dd] = fechaKey.split('-');
                    const mm2 = mm.padStart(2, '0');
                    const dd2 = dd.padStart(2, '0');
                    fechaKey = `${yyyy}-${mm2}-${dd2}`;
                }

                const docRef = db.collection("inventario_diario").doc(fechaKey);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    infoDivFecha.innerHTML = "<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>No hay hist√≥rico para la fecha seleccionada.</div>";
                    noHistFecha.style.display = 'block';
                    showLoading(false);
                    return;
                }
                historicoActualFecha = docSnap.data();
                const data = historicoActualFecha;
                // Ajustar para el formato guardado por inventario_diario
                if (!data.data || !Array.isArray(data.data)) {
                    infoDivFecha.innerHTML = "<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>El formato del hist√≥rico es incorrecto.</div>";
                    noHistFecha.style.display = 'block';
                    showLoading(false);
                    return;
                }
                infoDivFecha.innerHTML = `
                    <b>Archivo:</b> ${data.fileName || '-'} &nbsp; 
                    <b>Fecha:</b> ${data.fecha || '-'} &nbsp; 
                    <b>Registros:</b> ${data.rowCount || '-'
                }`;
                // Agregar bot√≥n de editar
                infoDivFecha.innerHTML += `
                    <button id="btnEditarFecha" style="margin-left:18px;padding:7px 18px;border-radius:7px;background:#fbbf24;color:#fff;font-weight:700;border:none;cursor:pointer;">‚úèÔ∏è Editar Registro</button>
                    <button id="btnGuardarFecha" style="margin-left:10px;padding:7px 18px;border-radius:7px;background:#22c55e;color:#fff;font-weight:700;border:none;cursor:pointer;display:none;">üíæ Guardar Cambios</button>
                `;
                if (data.data.length === 0) {
                    tablaBodyFecha.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#ef4444;">No hay productos en este hist√≥rico.</td></tr>`;
                } else {
                    data.data.forEach((item, idx) => {
                        // Buscar el valor de diferencia en cualquiera de los posibles nombres
                        let diferencia = 
                            item['DIFERENCIA'] ??
                            item['DIFERENCIAS'] ??
                            item['diferencia'] ??
                            item['diferencias'] ??
                            item['Diferencia'] ??
                            item['Diferencias'] ??
                            '';
                        // Si es 0, mostrar 0
                        if (diferencia === undefined || diferencia === null || diferencia === '') diferencia = '';
                        if (diferencia === 0) diferencia = 0;
                        tablaBodyFecha.innerHTML += `
                            <tr>
                                <td class="code-cell">${item['Material'] || item['material'] || ''}</td>
                                <td class="product-cell">${item['Texto breve de material'] || item['descripcion'] || ''}</td>
                                <td>${item['SAP'] || item['sap'] || ''}</td>
                                <td class="editable-fisico">${item['F√≠sico'] === 0 ? 0 : (item['F√≠sico'] || item['fisico'] || '')}</td>
                                <td class="editable-display">${item['Display'] === 0 ? 0 : (item['Display'] || item['display'] || '')}</td>
                                <td class="editable-merma">${item['Merma'] === 0 ? 0 : (item['Merma'] || item['merma'] || '')}</td>
                                <td>${diferencia}</td>
                            </tr>
                        `;
                    });
                }
                tablaContainerFecha.style.display = 'block';
                btnExportarFecha.style.display = 'inline-flex';
            } catch (error) {
                console.error("Error al buscar el hist√≥rico:", error);
                infoDivFecha.innerHTML = `<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>Error al buscar el hist√≥rico: ${error.message}</div>`;
                noHistFecha.style.display = 'block';
            } finally {
                showLoading(false);
            }
            setTimeout(() => {
        const btnEditar = document.getElementById('btnEditarFecha');
        const btnGuardar = document.getElementById('btnGuardarFecha');
        if (btnEditar) {
            btnEditar.onclick = function() {
                habilitarEdicionInventarioDiario();
                btnEditar.style.display = 'none';
                btnGuardar.style.display = '';
            };
        }
        if (btnGuardar) {
            btnGuardar.onclick = function() {
                guardarCambiosInventarioDiario();
            };
        }
    }, 100);
        }

        // Habilita edici√≥n en las columnas F√≠sico, Display, Merma (convierte a input solo al editar)
function habilitarEdicionInventarioDiario() {
    const filas = document.querySelectorAll('#tablaHistBodyFecha tr');
    filas.forEach((tr, idx) => {
        // F√≠sico
        const tdFisico = tr.querySelector('.editable-fisico');
        if (tdFisico && !tdFisico.querySelector('input')) {
            const valor = tdFisico.textContent;
            tdFisico.innerHTML = `<input type="number" step="any" class="input-fisico" style="width:80px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
        // Display
        const tdDisplay = tr.querySelector('.editable-display');
        if (tdDisplay && !tdDisplay.querySelector('input')) {
            const valor = tdDisplay.textContent;
            tdDisplay.innerHTML = `<input type="number" step="any" class="input-display" style="width:80px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
        // Merma
        const tdMerma = tr.querySelector('.editable-merma');
        if (tdMerma && !tdMerma.querySelector('input')) {
            const valor = tdMerma.textContent;
            tdMerma.innerHTML = `<input type="number" step="any" class="input-merma" style="width:80px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
        // Diferencias: recalcular al editar
        const tdDiferencia = tr.querySelector('td:last-child');
        // Obtener SAP (columna 3)
        const tdSAP = tr.querySelector('td:nth-child(3)');
        let sapValue = 0;
        if (tdSAP) {
            sapValue = parseFloat(tdSAP.textContent) || 0;
        }
        // Funci√≥n para recalcular diferencia
        function recalcularDiferencia() {
            const fisico = parseFloat(tr.querySelector('.input-fisico')?.value) || 0;
            const display = parseFloat(tr.querySelector('.input-display')?.value) || 0;
            const merma = parseFloat(tr.querySelector('.input-merma')?.value) || 0;
            const diferencia = fisico + display + merma - sapValue;
            tdDiferencia.textContent = isNaN(diferencia) ? '' : diferencia;
        }
        // Asignar eventos de recalculo
        const inputFisico = tr.querySelector('.input-fisico');
        const inputDisplay = tr.querySelector('.input-display');
        const inputMerma = tr.querySelector('.input-merma');
        if (inputFisico) inputFisico.addEventListener('input', recalcularDiferencia);
        if (inputDisplay) inputDisplay.addEventListener('input', recalcularDiferencia);
        if (inputMerma) inputMerma.addEventListener('input', recalcularDiferencia);
    });
}

// Guarda los cambios editados en Firestore para Inventario Diario
async function guardarCambiosInventarioDiario() {
    const filas = document.querySelectorAll('#tablaHistBodyFecha tr');
    if (!historicoActualFecha || !historicoActualFecha.data) return;
    filas.forEach((tr, idx) => {
        const inputFisico = tr.querySelector('.input-fisico');
        const inputDisplay = tr.querySelector('.input-display');
        const inputMerma = tr.querySelector('.input-merma');
        const tdSAP = tr.querySelector('td:nth-child(3)');
        const tdDiferencia = tr.querySelector('td:last-child');
        let sapValue = 0;
        if (tdSAP) sapValue = parseFloat(tdSAP.textContent) || 0;
        let fisico = inputFisico ? parseFloat(inputFisico.value) || 0 : 0;
        let display = inputDisplay ? parseFloat(inputDisplay.value) || 0 : 0;
        let merma = inputMerma ? parseFloat(inputMerma.value) || 0 : 0;
        let diferencia = fisico + display + merma - sapValue;
        if (inputFisico) historicoActualFecha.data[idx]['F√≠sico'] = inputFisico.value;
        if (inputDisplay) historicoActualFecha.data[idx]['Display'] = inputDisplay.value;
        if (inputMerma) historicoActualFecha.data[idx]['Merma'] = inputMerma.value;
        // Guardar la diferencia calculada
        historicoActualFecha.data[idx]['Diferencia'] = diferencia;
        if (tdDiferencia) tdDiferencia.textContent = isNaN(diferencia) ? '' : diferencia;
    });
    // Guardar en Firestore
    try {
        showLoading(true);
        const fechaKey = historicoActualFecha.fecha;
        await db.collection("inventario_diario").doc(fechaKey).update({
            data: historicoActualFecha.data
        });
        alert('Cambios guardados correctamente.');
        document.getElementById('btnEditarFecha').style.display = '';
        document.getElementById('btnGuardarFecha').style.display = 'none';
        // Recargar para mostrar los valores actualizados
        buscarHistoricoFecha();
    } catch (e) {
        alert('Error al guardar cambios: ' + e.message);
    } finally {
        showLoading(false);
    }
}

        // Buscar hist√≥rico general
        async function buscarHistoricoGeneral() {
            const fecha = fechaInputGeneral.value;
            if (!fecha) {
                alert("Por favor selecciona una fecha para buscar.");
                return;
            }
            showLoading(true);
            tablaBodyGeneral.innerHTML = '';
            infoDivGeneral.innerHTML = '';
            tablaContainerGeneral.style.display = 'none';
            noHistGeneral.style.display = 'none';
            btnExportarGeneral.style.display = 'none';
            historicoActualGeneral = null;

            try {
                // Buscar por ID de documento (fecha normalizada)
                let fechaKey = normalizarFecha(fecha);
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaKey)) {
                    const [yyyy, mm, dd] = fechaKey.split('-');
                    const mm2 = mm.padStart(2, '0');
                    const dd2 = dd.padStart(2, '0');
                    fechaKey = `${yyyy}-${mm2}-${dd2}`;
                }
                const docRef = db.collection("inventario_general").doc(fechaKey);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    infoDivGeneral.innerHTML = "<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>No hay hist√≥rico general para la fecha seleccionada.</div>";
                    noHistGeneral.style.display = 'block';
                    showLoading(false);
                    return;
                }
                const data = docSnap.data();
                historicoActualGeneral = data;
                // Usar la propiedad "data" o "datos" seg√∫n c√≥mo se guard√≥
                const datos = data.data || data.datos;
                if (!datos || !Array.isArray(datos)) {
                    infoDivGeneral.innerHTML = "<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>El formato del hist√≥rico general es incorrecto.</div>";
                    noHistGeneral.style.display = 'block';
                    showLoading(false);
                    return;
                }
                infoDivGeneral.innerHTML = `
                    <b>Fecha:</b> ${data.fecha || '-'} &nbsp; 
                    <b>Archivo:</b> ${data.fileName || '-'}
                    <button id="btnEditarGeneral" style="margin-left:18px;padding:7px 18px;border-radius:7px;background:#fbbf24;color:#fff;font-weight:700;border:none;cursor:pointer;">‚úèÔ∏è Editar Registro</button>
                    <button id="btnGuardarGeneral" style="margin-left:10px;padding:7px 18px;border-radius:7px;background:#22c55e;color:#fff;font-weight:700;border:none;cursor:pointer;display:none;">üíæ Guardar Cambios</button>
                `;
                if (datos.length > 0) {
                    const columnas = [
                        "Centro",
                        "Almac√©n",
                        "Material",
                        "Texto breve de material",
                        "Lote",
                        "SAP",
                        "REAL",
                        "DIFERENCIA"
                    ];
                    const thead = document.querySelector('#tablaHistGeneral thead tr');
                    thead.innerHTML = '';
                    columnas.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        thead.appendChild(th);
                    });
                    tablaBodyGeneral.innerHTML = '';
                    datos.forEach((item, idx) => {
                        let fila = '<tr>';
                        columnas.forEach(col => {
                            // SOLO para Lote, SAP, REAL: poner valor plano, input solo al editar
                            if (col === "Lote") {
                                fila += `<td class="editable-general-lote">${item[col] === 0 ? 0 : (item[col] || '')}</td>`;
                            } else if (col === "SAP") {
                                fila += `<td class="editable-general-sap">${item[col] === 0 ? 0 : (item[col] || '')}</td>`;
                            } else if (col === "REAL") {
                                fila += `<td class="editable-general-real">${item[col] === 0 ? 0 : (item[col] || '')}</td>`;
                            } else {
                                fila += `<td>${item[col] === 0 ? 0 : (item[col] || '')}</td>`;
                            }
                        });
                        fila += '</tr>';
                        tablaBodyGeneral.innerHTML += fila;
                    });
                } else {
                    tablaBodyGeneral.innerHTML = `<tr><td colspan="1" style="text-align:center;color:#ef4444;">No hay productos en este hist√≥rico.</td></tr>`;
                }
                tablaContainerGeneral.style.display = 'block';
                btnExportarGeneral.style.display = 'inline-flex';
            } catch (error) {
                console.error("Error al buscar el hist√≥rico general:", error);
                infoDivGeneral.innerHTML = `<div style='color:#ef4444;font-weight:bold;margin-top:8px;'>Error al buscar el hist√≥rico general: ${error.message}</div>`;
                noHistGeneral.style.display = 'block';
            } finally {
                showLoading(false);
            }
            setTimeout(() => {
        const btnEditar = document.getElementById('btnEditarGeneral');
        const btnGuardar = document.getElementById('btnGuardarGeneral');
        if (btnEditar) {
            btnEditar.onclick = function() {
                habilitarEdicionInventarioGeneral();
                btnEditar.style.display = 'none';
                btnGuardar.style.display = '';
            };
        }
        if (btnGuardar) {
            btnGuardar.onclick = function() {
                guardarCambiosInventarioGeneral();
            };
        }
    }, 100);
        }

        // Habilita edici√≥n en las columnas Lote, SAP, REAL (convierte a input solo al editar)
function habilitarEdicionInventarioGeneral() {
    const filas = document.querySelectorAll('#tablaHistBodyGeneral tr');
    filas.forEach((tr, idx) => {
        // Lote
        const tdLote = tr.querySelector('.editable-general-lote');
        if (tdLote && !tdLote.querySelector('input')) {
            const valor = tdLote.textContent;
            tdLote.innerHTML = `<input type="text" class="input-general-lote" style="width:90px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
        // SAP
        const tdSAP = tr.querySelector('.editable-general-sap');
        if (tdSAP && !tdSAP.querySelector('input')) {
            const valor = tdSAP.textContent;
            tdSAP.innerHTML = `<input type="text" class="input-general-sap" style="width:90px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
        // REAL
        const tdREAL = tr.querySelector('.editable-general-real');
        if (tdREAL && !tdREAL.querySelector('input')) {
            const valor = tdREAL.textContent;
            tdREAL.innerHTML = `<input type="number" step="any" class="input-general-real" style="width:90px;padding:4px 8px;border-radius:6px;border:1.2px solid #6366f1;" value="${valor}">`;
        }
    });
}

// Guarda los cambios editados en Firestore para Inventario General
async function guardarCambiosInventarioGeneral() {
    const filas = document.querySelectorAll('#tablaHistBodyGeneral tr');
    if (!historicoActualGeneral) return;
    const datos = historicoActualGeneral.data || historicoActualGeneral.datos;
    filas.forEach((tr, idx) => {
        const inputLote = tr.querySelector('.input-general-lote');
        const inputSAP = tr.querySelector('.input-general-sap');
        const inputREAL = tr.querySelector('.input-general-real');
        if (inputLote) datos[idx]['Lote'] = inputLote.value;
        if (inputSAP) datos[idx]['SAP'] = inputSAP.value;
        if (inputREAL) datos[idx]['REAL'] = inputREAL.value;
    });
    try {
        showLoading(true);
        const fechaKey = historicoActualGeneral.fecha;
        let updateObj = {};
        if (historicoActualGeneral.data) {
            updateObj.data = datos;
        } else {
            updateObj.datos = datos;
        }
        await db.collection("inventario_general").doc(fechaKey).update(updateObj);
        alert('Cambios guardados correctamente.');
        document.getElementById('btnEditarGeneral').style.display = '';
        document.getElementById('btnGuardarGeneral').style.display = 'none';
        buscarHistoricoGeneral();
    } catch (e) {
        alert('Error al guardar cambios: ' + e.message);
    } finally {
        showLoading(false);
    }
}

// Exportar a Excel (fecha)
        function exportarExcelFecha() {
            if (!historicoActualFecha || !Array.isArray(historicoActualFecha.data)) {
                alert("No hay datos para exportar.");
                return;
            }
            showLoading(true);
            setTimeout(() => {
                try {
                    const wsData = [
                        ["Material", "Texto breve de material", "SAP", "F√≠sico", "Display", "Merma", "Diferencias"]
                    ];
                    historicoActualFecha.data.forEach(item => {
                        // Buscar el valor de diferencia en cualquiera de los posibles nombres
                        let diferencia = 
                            item['DIFERENCIA'] ??
                            item['DIFERENCIAS'] ??
                            item['diferencia'] ??
                            item['diferencias'] ??
                            item['Diferencia'] ??
                            item['Diferencias'] ??
                            '';
                        if (diferencia === undefined || diferencia === null || diferencia === '') diferencia = '';
                        if (diferencia === 0) diferencia = 0;
                        wsData.push([
                            item['Material'] || item['material'] || '',
                            item['Texto breve de material'] || item['descripcion'] || '',
                            item['SAP'] || item['sap'] || '',
                            item['F√≠sico'] === 0 ? 0 : (item['F√≠sico'] || item['fisico'] || ''),
                            item['Display'] === 0 ? 0 : (item['Display'] || item['display'] || ''),
                            item['Merma'] === 0 ? 0 : (item['Merma'] || item['merma'] || ''),
                            diferencia
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Hist√≥rico");
                    let nombreArchivo = "historico_inventario_fecha.xlsx";
                    if (historicoActualFecha.fecha) {
                        nombreArchivo = `historico_inventario_${historicoActualFecha.fecha}.xlsx`;
                    }
                    XLSX.writeFile(wb, nombreArchivo);
                } catch (e) {
                    alert("Error al exportar a Excel: " + e.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        // Exportar a Excel (general)
        function exportarExcelGeneral() {
            // Soporta ambos: data o datos
            let datos = null;
            if (historicoActualGeneral) {
                if (Array.isArray(historicoActualGeneral.datos)) {
                    datos = historicoActualGeneral.datos;
                } else if (Array.isArray(historicoActualGeneral.data)) {
                    datos = historicoActualGeneral.data;
                }
            }
            if (!datos) {
                alert("No hay datos para exportar.");
                return;
            }
            showLoading(true);
            setTimeout(() => {
                try {
            // Columnas en el orden solicitado
            const columnasDeseadas = [
                "Centro",
                "Almac√©n",
                "Material",
                "Texto breve de material",
                "Lote",
                "SAP",
                "REAL",
                "DIFERENCIA"
            ];
            // Filtrar solo las columnas que existen en los datos
            const keys = Object.keys(datos[0]);
            const columnas = columnasDeseadas.filter(col => keys.includes(col));
            // Encabezados
            const wsData = [columnas];
            // Filas
            datos.forEach(item => {
                wsData.push(columnas.map(col => item[col] === 0 ? 0 : (item[col] || '')));
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hist√≥rico General");
            let nombreArchivo = "historico_inventario_general.xlsx";
            if (historicoActualGeneral.fecha) {
                nombreArchivo = `historico_inventario_general_${historicoActualGeneral.fecha}.xlsx`;
            }
            XLSX.writeFile(wb, nombreArchivo);
                } catch (e) {
                    alert("Error al exportar a Excel: " + e.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        // Asignar eventos a los botones
        btnBuscarFecha.addEventListener('click', buscarHistoricoFecha);
        btnBuscarGeneral.addEventListener('click', buscarHistoricoGeneral);
        btnExportarFecha.addEventListener('click', exportarExcelFecha);
        btnExportarGeneral.addEventListener('click', exportarExcelGeneral);
    </script>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
